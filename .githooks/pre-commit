#!/usr/bin/env bash
set -euo pipefail

COMMITHOOKS_DIR="${COMMITHOOKS_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"
# shellcheck disable=SC1091
source "$COMMITHOOKS_DIR/lib/common.sh"
# shellcheck disable=SC1091
source "$COMMITHOOKS_DIR/lib/secrets.sh"

commithooks_skip_during_rebase && exit 0

commithooks_block_sensitive_files
commithooks_scan_secrets_in_diff

# Shellcheck all staged .sh files and hook scripts
staged="$(commithooks_staged_files)"
if [ -n "$staged" ]; then
  shell_files="$(echo "$staged" | grep -E '\.(sh|bash)$' || true)"
  hook_files="$(echo "$staged" | grep -E '(^|/)(pre-commit|commit-msg|pre-push|post-commit|post-checkout|post-merge)$' || true)"
  all_files="$(printf '%s\n%s' "$shell_files" "$hook_files" | sort -u | grep -v '^$' || true)"

  if [ -n "$all_files" ] && commithooks_require_cmd "shellcheck"; then
    commithooks_green "[pre-commit] Running shellcheck..."
    # shellcheck disable=SC2086
    shellcheck $all_files
  fi

  # Syntax check
  if [ -n "$all_files" ]; then
    commithooks_green "[pre-commit] Running bash -n syntax check..."
    local_err=0
    while IFS= read -r f; do
      if [ -f "$f" ] && ! bash -n "$f" 2>/dev/null; then
        commithooks_red "[pre-commit] Syntax error in: $f"
        local_err=1
      fi
    done <<< "$all_files"
    if [ "$local_err" -ne 0 ]; then
      exit 1
    fi
  fi
fi
